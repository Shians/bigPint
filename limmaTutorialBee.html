<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="generator" content="pandoc" />

    <meta name="author" content="Lindsay Rutter" />
  
  
  <title>Limma Tutorial</title>

    <script src="limmaTutorialBee_files/jquery-1.11.3/jquery.min.js"></script>
  <link href="limmaTutorialBee_files/bootstrap-3.3.2/css/bootstrap.min.css" rel="stylesheet" />
  <script src="limmaTutorialBee_files/bootstrap-3.3.2/js/bootstrap.min.js"></script>
  <script src="limmaTutorialBee_files/bootstrap-3.3.2/shim/html5shiv.min.js"></script>
  <script src="limmaTutorialBee_files/bootstrap-3.3.2/shim/respond.min.js"></script>
  <link href="limmaTutorialBee_files/highlight-8.4/tomorrow.css" rel="stylesheet" />
  <script src="limmaTutorialBee_files/highlight-8.4/highlight.pack.js"></script>
  <link href="limmaTutorialBee_files/fontawesome-4.3.0/css/font-awesome.min.css" rel="stylesheet" />
  <script src="limmaTutorialBee_files/stickykit-1.1.1/sticky-kit.min.js"></script>
  <script src="limmaTutorialBee_files/jqueryeasing-1.3/jquery.easing.min.js"></script>
  <link href="limmaTutorialBee_files/recliner-0.2.2/recliner.css" rel="stylesheet" />
  <script src="limmaTutorialBee_files/recliner-0.2.2/recliner.min.js"></script>
  <script src="limmaTutorialBee_files/recliner-0.2.2/onload.js"></script>
  <link href="limmaTutorialBee_files/packagedocs-0.0.1/pd.css" rel="stylesheet" />
  <script src="limmaTutorialBee_files/packagedocs-0.0.1/pd.js"></script>
  <script src="limmaTutorialBee_files/packagedocs-0.0.1/pd-sticky-toc.js"></script>
  
  
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>

<body>

  
  <header class="navbar navbar-white navbar-fixed-top" role="banner" id="header">
    <div class="container">
      <div class="navbar-header">
        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
                <a href="index.html" class="navbar-brand page-scroll">
        Limma Tutorial
        </a>
      </div>
          </div>
  </header>

  <!-- Begin Body -->
  <div class="container">
    <div class="row">
            <div class="col-md-12">
      
<div id="content-top"></div>
<p><meta http-equiv="content-type" content="text/html;charset=utf-8" /></p>
<p>Try new paper (<a href="https://www.bioconductor.org/help/workflows/RNAseq123/" class="uri">https://www.bioconductor.org/help/workflows/RNAseq123/</a>)</p>
<pre class="r"><code>library(limma)
library(Glimma)
library(edgeR)

thisPath &lt;- &quot;/Users/lindz/bigPint&quot;
beeCounts &lt;-read.delim(file=&quot;AllLaneCount.txt&quot;,row.names=1,stringsAsFactors = FALSE)
colnames(beeCounts) &lt;- c(&quot;NC.1&quot;, &quot;NC.2&quot;, &quot;NR.1&quot;, &quot;VR.1&quot;, &quot;NS.1&quot;, &quot;VP.1&quot;, &quot;NS.2&quot;, &quot;VR.2&quot;, &quot;NP.1&quot;, &quot;VP.2&quot;, &quot;VC.1&quot;, &quot;NP.2&quot;, &quot;VP.3&quot;, &quot;NP.3&quot;, &quot;VS.1&quot;, &quot;VS.2&quot;, &quot;VC.2&quot;, &quot;NC.3&quot;, &quot;VP.4&quot;, &quot;NC.4&quot;, &quot;NR.2&quot;, &quot;VC.3&quot;, &quot;VC.4&quot;, &quot;NP.4&quot;, &quot;VR.3&quot;, &quot;NC.5&quot;, &quot;VS.3&quot;, &quot;NP.5&quot;, &quot;VC.5&quot;, &quot;VS.4&quot;, &quot;NS.3&quot;, &quot;VS.5&quot;, &quot;VP.5&quot;, &quot;NR.3&quot;, &quot;NR.4&quot;, &quot;VC.6&quot;, &quot;NS.4&quot;, &quot;NC.6&quot;, &quot;NP.6&quot;, &quot;VR.4&quot;, &quot;NR.5&quot;, &quot;NR.6&quot;, &quot;NS.5&quot;, &quot;VP.6&quot;, &quot;NS.6&quot;, &quot;VR.5&quot;, &quot;VR.6&quot;, &quot;VS.6&quot;)
beeCounts &lt;- beeCounts[ , order(names(beeCounts))]
x &lt;- DGEList(counts=beeCounts)

#samplenames &lt;- substring(colnames(x), 12, nchar(colnames(x)))
#colnames(x) &lt;- samplenames
group &lt;- as.factor(colnames(x))
group &lt;- factor(c(rep(&quot;NC&quot;,6), rep(&quot;NP&quot;,6), rep(&quot;NR&quot;,6), rep(&quot;NS&quot;,6), rep(&quot;VC&quot;,6), rep(&quot;VP&quot;,6), rep(&quot;VR&quot;,6), rep(&quot;VS&quot;,6)))
x$samples$group &lt;- group
lane &lt;- as.factor(c(&quot;L12&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L12&quot;,&quot;L12&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L34&quot;,&quot;L34&quot;))
x$samples$lane &lt;- lane</code></pre>
<p>Transform and remove low counts.</p>
<pre class="r"><code>cpm &lt;- cpm(x)
lcpm &lt;- cpm(x, log=TRUE)
keep.exprs &lt;- rowSums(cpm&gt;1)&gt;=48
x &lt;- x[keep.exprs,, keep.lib.sizes=FALSE] # 15,314 to 10,626
dim(x)</code></pre>
<pre><code>[1] 8088   48</code></pre>
<pre class="r"><code>x &lt;- calcNormFactors(x, method = &quot;TMM&quot;)</code></pre>
<p>Create MDS plots</p>
<pre class="r"><code>library(RColorBrewer)
lcpm &lt;- cpm(x, log=TRUE)
par(mfrow=c(1,2))
col.group &lt;- group
levels(col.group) &lt;-  brewer.pal(nlevels(col.group), &quot;Set1&quot;)
col.group &lt;- as.character(col.group)
col.lane &lt;- lane
levels(col.lane) &lt;-  brewer.pal(nlevels(col.lane), &quot;Set2&quot;)</code></pre>
<pre><code>Warning in brewer.pal(nlevels(col.lane), &quot;Set2&quot;): minimal value for n is 3, returning requested palette with 3 different levels</code></pre>
<pre class="r"><code>col.lane &lt;- as.character(col.lane)
plotMDS(lcpm, labels=group, col=col.group)</code></pre>
<p><img src="limmaTutorialBee_files/figure-html/unnamed-chunk-3-1.png" width="960" /></p>
<pre class="r"><code>plotMDS(lcpm, labels=lane, col=col.lane, dim=c(3,4))</code></pre>
<p><img src="limmaTutorialBee_files/figure-html/unnamed-chunk-4-1.png" width="960" /></p>
<pre class="r"><code>glMDSPlot(lcpm, labels=paste(group, lane, sep=&quot;_&quot;), groups=x$samples[,c(1,4)], launch=FALSE)

#rows &lt;- which(x$samples$group %in% c(&quot;NP&quot;,&quot;VS&quot;))
#glMDSPlot(lcpm[,rows], labels=paste(group, lane, sep=&quot;_&quot;), groups=x$samples[rows,c(1,4)], launch=TRUE)</code></pre>
<p>Create design matrix. There are many ways to setup a design matrix. Here, we removed the intercept from group (the first factor), but kept the intercept from lane. This allows us to do contrasts with group more easily.</p>
<pre class="r"><code>design &lt;- model.matrix(~0+group+lane)
colnames(design) &lt;- gsub(&quot;group&quot;, &quot;&quot;, colnames(design))</code></pre>
<p>We can look at contrasts</p>
<pre class="r"><code>contr.matrix &lt;- makeContrasts(
   NPvsVS = NP-VS, 
   NPvsNC = NP-NC, 
   VPvsVS = VP-VS, 
   levels = colnames(design))
contr.matrix</code></pre>
<pre><code>         Contrasts
Levels    NPvsVS NPvsNC VPvsVS
  NC           0     -1      0
  NP           1      1      0
  NR           0      0      0
  NS           0      0      0
  VC           0      0      0
  VP           0      0      1
  VR           0      0      0
  VS          -1      0     -1
  laneL34      0      0      0</code></pre>
<pre class="r"><code>par(mfrow=c(1,2))
v &lt;- voom(x, design, plot=TRUE)
vfit &lt;- lmFit(v, design)
vfit &lt;- contrasts.fit(vfit, contrasts=contr.matrix)
efit &lt;- eBayes(vfit)
plotSA(efit, main=&quot;Final model: Mean−variance trend&quot;)</code></pre>
<p><img src="limmaTutorialBee_files/figure-html/unnamed-chunk-8-1.png" width="960" /></p>
<p>For a quick look at differential expression levels, the number of significantly up- and down-regulated genes can be summarised in a table. Significance is defined using an adjusted p-value cutoff that is set at 5% by default. For the comparison between expression levels in basal and LP, 4,127 genes are found to be down-regulated in basal relative to LP and 4,298 genes are up-regulated in basal relative to LP – a total of 8,425 DE genes.</p>
<pre class="r"><code>summary(decideTests(efit))</code></pre>
<pre><code>   NPvsVS NPvsNC VPvsVS
-1    480      0      0
0    8863  10249  10249
1     906      0      0</code></pre>
<p>Some studies require more than an adjusted p-value cut-off. For a stricter definition on significance, one may require log-fold-changes (log-FCs) to be above a minimum value. The treat method can be used to calculate p-values from empirical Bayes moderated t-statistics with a minimum log-FC requirement. The number of differentially expressed genes are reduced to a total of 3,135 DE genes for basal versus LP, 3,270 DE genes for basal versus ML, and 385 DE genes for LP versus ML when testing requires genes to have a log-FC that is significantly greater than 1 (equivalent to a 2-fold difference between cell types on the original scale).</p>
<pre class="r"><code>tfit &lt;- treat(vfit, lfc=1)
dt &lt;- decideTests(tfit)
summary(dt)</code></pre>
<pre><code>   NPvsVS NPvsNC VPvsVS
-1      0      0      0
0   10249  10249  10249
1       0      0      0</code></pre>
<p>Genes that are DE in multiple comparisons can be extracted using the results from decideTests, where 0s represent genes that are not DE, 1s represent genes that are up-regulated, and -1s represent genes that are down-regulated. A total of 2,409 genes are DE in both basal versus LP and basal versus ML, twenty of which are listed below. The write.fit function can be used to extract and write results for all three comparisons to a single output file.</p>
<pre class="r"><code>de.common &lt;- which(dt[,1]!=0 &amp; dt[,2]!=0)
length(de.common)</code></pre>
<pre><code>[1] 0</code></pre>
<pre class="r"><code>head(tfit$genes$SYMBOL[de.common], n=20)</code></pre>
<pre><code>NULL</code></pre>
<pre class="r"><code>vennDiagram(dt[,1:2], circle.col=c(&quot;turquoise&quot;, &quot;salmon&quot;))</code></pre>
<p><img src="limmaTutorialBee_files/figure-html/unnamed-chunk-11-1.png" width="960" /></p>
<p>We can examine genes from top to bottom</p>
<pre class="r"><code>basal.vs.lp &lt;- topTreat(tfit, coef=1, n=Inf)
basal.vs.ml &lt;- topTreat(tfit, coef=2, n=Inf)
head(basal.vs.lp)
head(basal.vs.ml)</code></pre>
<p>To summarise results for all genes visually, mean-difference plots, which display log-FCs from the linear model fit against the average log-CPM values can be generated using the plotMD function, with the differentially expressed genes highlighted.</p>
<pre class="r"><code>plotMD(tfit, column=1, status=dt[,1], main=colnames(tfit)[1], xlim=c(-8,13))</code></pre>
<p><img src="limmaTutorialBee_files/figure-html/unnamed-chunk-13-1.png" width="960" /></p>
<p>A heatmap is created for the top 100 DE genes (as ranked by adjusted p-value) from the basal versus LP contrast using the heatmap.2 function from the gplots package. The heatmap correctly clusters samples into cell type and rearranges the order of genes to form blocks of similar expression. From the heatmap, we observe that the expression of ML and LP samples are very similar for the top 100 DE genes between basal and LP.</p>
<pre class="r"><code>library(gplots)
basal.vs.lp.topgenes &lt;- basal.vs.lp$ENTREZID[1:100]
i &lt;- which(v$genes$ENTREZID %in% basal.vs.lp.topgenes)
mycol &lt;- colorpanel(1000,&quot;blue&quot;,&quot;white&quot;,&quot;red&quot;)
heatmap.2(v$E[i,], scale=&quot;row&quot;, labRow=v$genes$SYMBOL[i], labCol=group, col=mycol, trace=&quot;none&quot;, density.info=&quot;none&quot;, margin=c(8,6), lhei=c(2,10), dendrogram=&quot;column&quot;)</code></pre>


      </div>
    </div>
  </div>

  <div id="footer">
    <div class="container">
      <div class="col-md-6">
              </div>
      <div class="col-md-6">
        <p class="pull-right">created with <a href="https://github.com/hafen/packagedocs">packagedocs</a>
                  </p>
      </div>
    </div>
  </div>

  
</body>
</html>
